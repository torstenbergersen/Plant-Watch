<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plant Moisture Chart</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <script src="./chart.js/dist/chart.umd.js"></script>
    <script src="./chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Plant Watch</h1>
      <div class="canvas-container">
        <canvas id="moistureChart"></canvas>
        <script>
          const socket = io();

          let chart;

          const dataPoints = {
            Spathiphyllum: [],
            Philodendron: [],
            Calethea: [],
          };

          const ctx = document.getElementById("moistureChart").getContext("2d");
          new Chart(ctx, {
            type: "line",
            data: {
              datasets: [
                {
                  label: "Spathiphyllum",
                  data: dataPoints["Spathiphyllum"],
                  borderColor: "red",
                  fill: false,
                },
                {
                  label: "Philodendron",
                  data: dataPoints["Philodendron"],
                  borderColor: "blue",
                  fill: false,
                },
                {
                  label: "Calethea",
                  data: dataPoints["Calethea"],
                  borderColor: "green",
                  fill: false,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: "bottom",
                  labels: {
                    font: {
                      size: 18,
                    },
                  },
                },
                title: {
                  display: true,
                  text: "Real Time Soil Moisture Levels",
                  font: {
                    size: 25,
                  },
                },
              },
              scales: {
                x: {
                  type: "time",
                  time: {
                    unit: "hour",
                  },
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Time",
                  },
                },
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    callback: function (value) {
                      return value + "%";
                    },
                  },
                  display: true,
                  scaleLabel: {
                    display: true,
                    labelString: "Moisture (%)",
                  },
                },
              },
            },
          });

          socket.on("newReading", function (reading) {
            const { plant, value, time } = reading;
            if (dataPoints[plant]) {
              const newData = { x: time, y: value };
              const dataset = chart.data.datasets.find(
                (d) => d.label === plant
              );
              dataset.data.push(newData);
              chart.update();
            }
          });
        </script>
      </div>
    </div>
  </body>
</html>
